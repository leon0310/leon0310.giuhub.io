GPIO是通用输入输出端口的简称，简单来说就是STM32可控制的引脚，STM32芯片的GPIO引脚与外部设备连接起来，从而实现与外部通讯、控制以及数据采集的功能。 STM32芯片的GPIO被分成很多组，每组有16个引脚（也有可能少于16个），如型号为STM32F103VET6型号的芯片有GPIOA、GPIOB、GPIOC至GPIOE共5组GPIO，该芯片一共100个引脚，其中GPIO引脚就占了一大部分，所有的GPIO引脚都有基本的输入输出功能。

最基本的输出功能是由STM32控制引脚输出高、低电平，实现开关控制，如把GPIO引脚接入到LED灯，那就可以控制LED灯的亮灭，引脚接入到继电器或三极管，那就可以通过继电器或三极管控制外部大功率电路的通断。

最基本的输入功能是检测外部输入电平，如把GPIO引脚连接到按键，通过电平高低区分按键是否被按下。

## 1.框图剖析

![image130](https://github.com/user-attachments/assets/66f1ec2c-35dd-43c0-96bd-f6209b766506)

通过GPIO硬件结构框图，就可以从整体上深入了解GPIO外设及它的各种应用模式。该图从最右端看起，最右端就是代表STM32芯片引出的GPIO引脚，其余部件都位于芯片内部。

### 1.1保护二极管
引脚的两个保护二级管可以防止引脚外部过高或过低的电压输入，当引脚电压高于VDD时， 上方的二极管导通，当引脚电压低于VSS时，下方的二极管导通，防止不正常电压引入芯片导致芯片烧毁。

### 1.2 P-MOS管和N-MOS管
GPIO引脚线路经过两个保护二极管后，向上流向“输入模式”结构，向下流向“输出模式”结构。先看输出模式部分，线路经过一个由P-MOS和N-MOS管组成的单元电路。这个结构使GPIO具有了“推挽输出”和“开漏输出”两种模式。

1.2.1推挽输出：
输入高电平：经过反向后，P-MOS导通、N-MOS关闭，对外输出高电平
输入低电平：经过反向后，N-MOS导通，P-MOS关闭，对外输出低电平。
当引脚高低电平切换时， 两个管子轮流导通，P管负责灌电流，N管负责拉电流，使其负载能力和开关速度都比普通的方式有很大的提高。推挽输出的低电平为0伏， 高电平为3.3伏

> 推挽输出模式
![image229](https://github.com/user-attachments/assets/92783870-aae3-44db-b7ea-62bcd8af2622)

1.2.2开漏输出：
上方的P-MOS管完全不工作。如果我们控制输出为0，低电平，则P-MOS管关闭，N-MOS管导通，使输出接地，若控制输出为1 (它无法直接输出高电平)时，则P-MOS管和N-MOS管都关闭，所以引脚既不输出高电平，也不输出低电平，为**高阻态**。它具有“线与”特性，也就是说，若有很多个开漏模式引脚连接到一起时，只有当所有引脚都输出高阻态，才由上拉电阻提供高电平，此高电平的电压为外部上拉电阻所接的电源的电压。若其中一个引脚为低电平，那线路就相当于短路接地，使得整条线路都为低电平，0伏。

推挽输出模式一般应用在输出电平为0和3.3伏而且需要高速切换开关状态的场合。在STM32的应用中，除了必须用开漏模式的场合，我们都习惯使用推挽输出模式。

> 开漏输出模式
![image324](https://github.com/user-attachments/assets/a1546d89-85e0-43d5-83e4-6dbb565500af)

### 1.3输出数据寄存器
双MOS管结构电路的输入信号，是由GPIO“输出数据寄存器GPIOx_ODR”提供的，因此我们通过修改输出数据寄存器的值就可以修改GPIO引脚的输出电平。而“置位/复位寄存器GPIOx_BSRR”可以通过修改输出数据寄存器的值从而影响电路的输出。

### 1.4复用功能输出
“复用”：指STM32的其它片上外设对GPIO引脚进行控制。（算是第二用途）
从其它外设引出来的“复用功能输出信号”与GPIO本身的数据据寄存器都连接到双MOS管结构的输入中，通过图中的梯形结构作为开关切换选择。
例如我们使用USART串口通讯时，需要用到某个GPIO引脚作为通讯发送引脚，这个时候就可以把该GPIO引脚配置成USART串口复用功能，由串口外设控制该引脚，发送数据。

### 1.5模拟输入输出
当GPIO引脚用于ADC采集电压的输入通道时，用作“模拟输入”功能。
（此时信号不经过施密特触发器，因为经过施密特触发器后信号只有0、1两种状态）
ADC外设要采集到原始的模拟信号，信号源输入必须在施密特触发器之前。类似地，当GPIO引脚用于DAC作为模拟电压输出通道时，此时作为“模拟输出”功能，DAC的模拟信号输出就不经过双MOS管结构，模拟信号直接输出到引脚。

### 1.6. GPIO工作模式
```
 typedef enum
 {
     GPIO_Mode_AIN = 0x0,           // 模拟输入
     GPIO_Mode_IN_FLOATING = 0x04,  // 浮空输入
     GPIO_Mode_IPD = 0x28,          // 下拉输入
     GPIO_Mode_IPU = 0x48,          // 上拉输入
     GPIO_Mode_Out_OD = 0x14,       // 开漏输出
     GPIO_Mode_Out_PP = 0x10,       // 推挽输出
     GPIO_Mode_AF_OD = 0x1C,        // 复用开漏输出
     GPIO_Mode_AF_PP = 0x18         // 复用推挽输出
 } GPIOMode_TypeDef;
```
在固件库中，GPIO总共有8种细分的工作模式，稍加整理可以大致归类为以下三类：

1.6.1  输入模式(模拟/浮空/上拉/下拉) 【只允许输入，输出被禁止】

在输入模式时，施密特触发器打开，输出被禁止，可通过输入数据寄存器GPIOx_IDR读取I/O状态。其中输入模式，可设置为上拉、下拉、浮空和模拟输入四种。上拉和下拉输入很好理解，默认的电平由上拉或者下拉决定。浮空输入的电平是不确定的，完全由外部的输入决定，一般接按键的时候用的是这个模式。模拟输入则用于ADC采集。

1.6.2 输出模式(推挽/开漏)

复用功能模式中，输出使能，输出速度可配置，可工作在开漏及推挽模式，但是输出信号源于其它外设，输出数据寄存器GPIOx_ODR无效；输入可用，通过输入数据寄存器可获取I/O实际状态，但一般直接用外设的寄存器来获取该数据信号。

## 2.端口配置

### 2.1 端口配置低寄存器

![image515](https://github.com/user-attachments/assets/d752d5db-ce64-4c50-8196-1520cb11badd)

### 2.2 端口配置高寄存器

![image614](https://github.com/user-attachments/assets/1aa8fca5-d46b-4be5-b6b6-2f0aefa360b3)

**参考与致谢**
[使用寄存器点亮LED灯](https://doc.embedfire.com/mcu/stm32/f103/hal_generalzh/latest/doc/chapter7/chapter7.html)